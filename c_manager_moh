CREATE TABLE teaching_activity (
	id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	activity_name VARCHAR(50) UNIQUE NOT NULL,
	factor DECIMAL(4,2) NOT NULL
)

CREATE TABLE planned_activity (
	id INT GENERATED ALWAYS AS IDENTITY,
	course_instance_id INT NOT NULL,
	planned_hours INT NOT NULL,
	teaching_activity_id INT NOT NULL,
	PRIMARY KEY (id, course_instance_id)
)


CREATE TABLE course_instance (
	id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	instance_id VARCHAR(50) UNIQUE NOT NULL,
	num_students INT NOT NULL,
	study_year VARCHAR(4) NOT NULL,
	course_layout_id INT NOT NULL,
	exam_hours_d NUMERIC,
	admin_hours_d NUMERIC
)

CREATE TABLE course_layout (
	id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	course_code VARCHAR(50) UNIQUE NOT NULL,
	course_name VARCHAR(100) NOT NULL,
	min_students INT NOT NULL,
	max_students INT NOT NULL,
	hp DECIMAL(3,1),
	is_active BOOLEAN NOT NULL,
	study_period VARCHAR(2) NOT NULL
)

CREATE TABLE rules (
	id INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	allocation_limit INT
)

INSERT INTO rules (allocation_limit)
VALUES (4)


ALTER TABLE course_instance
ADD CONSTRAINT fk_course_layout_id
FOREIGN KEY (course_layout_id)
REFERENCES course_layout(id)


ALTER TABLE planned_activity
ADD CONSTRAINT fk_course_instance_id
FOREIGN KEY (course_instance_id)
REFERENCES course_instance(id)


ALTER TABLE planned_activity
ADD CONSTRAINT fk_teaching_activity_id
FOREIGN KEY (teaching_activity_id)
REFERENCES teaching_activity(id)



--trigger to check if num_students of each instance is between the minimum and maximum in course_layout 
CREATE OR REPLACE FUNCTION check_num_students()
RETURNS TRIGGER AS $$
DECLARE
	layout_min_students INT;
	layout_max_students INT;
BEGIN
	SELECT course_layout.min_students, course_layout.max_students
	INTO layout_min_students, layout_max_students
	FROM course_layout
	WHERE course_layout.id = NEW.course_layout_id;

	IF NOT FOUND THEN
		RAISE EXCEPTION 'Cannot find course layout for id: %', NEW.id;
	END IF;

	IF NEW.num_students < layout_min_students THEN
		RAISE EXCEPTION 'Number of students (%) is below minimum (%)', NEW.num_students, layout_min_students;
    END IF;

	IF NEW.num_students > layout_max_students THEN
		RAISE EXCEPTION 'Number of students (%) is above maximum (%)', NEW.num_students, layout_max_students;
	END IF;


	
	RETURN NEW;

END;

$$ LANGUAGE plpgsql;

--create the actual trigger
CREATE TRIGGER validate_num_students
	BEFORE INSERT OR UPDATE OF num_students
	ON course_instance 
	FOR EACH ROW 
	EXECUTE FUNCTION check_num_students();



--end trigger
